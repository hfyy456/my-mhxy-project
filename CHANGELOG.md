<!--
 * @Author: Sirius 540363975@qq.com
 * @Date: 2025-06-15 06:15:28
 * @LastEditors: Sirius 540363975@qq.com
 * @LastEditTime: 2025-06-18 03:55:46
-->
# 更新日志 (Changelog)

所有此项目的更改将记录在此文件中。

该格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循[语义化版本](https://semver.org/spec/v2.0.0.html)。

---

## [3.1.0] - 2025-01-29 - 战斗体验全方位升级

### ✨ 新增 (Features)

- **新增"二连击、嗜血追击"技能**:
  - 实现了一个全新的、具有复杂动画脚本的多段攻击技能。
  - 动画系统已升级，支持更精细的位移和动画状态控制。
- **引入伪随机暴击机制 (PRD)**:
  - 采用伪随机分布算法重构了暴击逻辑，避免了玩家因"运气不佳"而长时间不暴击的情况，使暴击体验更公平、更可控。
- **全新的战斗网格视觉**:
  - 彻底重新设计了战斗网格，引入了科技感的六边形背景和动态"呼吸"光晕效果。
  - 增强了选中和悬停状态下的高亮效果，交互更清晰。
- **精致化的单位显示**:
  - 为每个单位增加了阴影底座，增强了立体感。
  - 重新设计了单位信息牌，整合了单位名称和HP条。
  - 为被击败的单位增加了灰度滤镜，使其状态更明确。
- **动画系统升级**:
  - 动画系统现在支持`PAUSE`指令，用于实现"命中停顿"效果，增强打击感。
  - 动画系统现在支持`CLEAR_ENTITY_ANIMATION`指令，解决了多段攻击中动画被覆盖的问题。

### 🎨 优化 (Improvements)

- **伤害数字美化**:
  - 实现了全新的伤害数字样式，区分暴击（红色）与非暴击（黄色），并带有清晰的描边和阴影，可读性大幅提升。
  - 为伤害数字增加了更生动、更有力的跳出动画。
- **受击动画优化**:
  - 重做了受击后退动画，解决了动作僵硬的问题，使其更平滑、更富有弹性。
  - 优化了动画时间轴，增强了连击技能的节奏感和力量感。
- **暴击逻辑优化**:
  - 暴击伤害和几率现在会正确地从单位的`derivedAttributes`属性中读取。

### 🐛 修复 (Bug Fixes)

- **修复了布局抖动问题**:
  - 通过使用`outline`替代`box-shadow`，彻底解决了在选中或悬停单位时因布局重算导致的界面抖动问题。
- **修复了伤害数字显示问题**:
  - 解决了在某些情况下伤害数字可能显示为黑色的问题。
- **修复了"二连击"动画目标错误**:
  - 修正了第二次攻击的动画和特效错误地施加在攻击者自身而非目标身上的严重问题。

### 🛠️ 重构 (Refactoring)

- **技能逻辑与状态机分离**:
  - 将技能执行、伤害计算和动画脚本生成的逻辑从核心状态机(`battleMachine.js`)中分离出来，封装到独立的`skillExecution.js`模块中，使状态机更专注于流程控制，大幅提高了代码的可维护性和扩展性。

## [0.4.0] - 2025-06-18 - "智能战场"

此版本对战斗系统的核心逻辑和UI流程进行了重大升级，引入了战斗结果展示、智能目标选择以及更丰富的动画效果，显著提升了战斗的完整性和策略性。

### ✨ 新增 (Added)

- **战斗结果页面**: 战斗结束后，会显示一个专门的胜利/失败界面，而不是直接退出，为玩家提供明确的战斗总结。
- **战斗动画系统**: 为直接攻击（如普通攻击）实现了全新的移动和攻击动画，包括单位移动到目标面前、攻击、受击反馈和返回原位。
- **VFX和浮动文字**: 为攻击、防御、受击、治疗和捕捉等多种战斗事件添加了视觉特效（VFX）和浮动文字提示。

### ♻️ 优化 (Changed)

- **智能目标重定向**: 当技能或攻击的原定目标在行动前阵亡时，系统现在会根据技能类型（对敌或对友）自动选择一个新的有效存活目标，使AI和玩家操作更加智能。
- **状态机流程优化**: 重构了战斗状态机（`battleMachine.js`），引入了 `results` 状态，使战斗流程在进入最终结果展示时更加清晰和稳定。
- **动画播放器增强**: `AnimationPlayer` 组件得到增强，可以处理基于单位位置的复杂动画序列（如移动到目标）。

### 🐛 修复 (Fixed)

- **防止攻击已阵亡单位**: 彻底解决了在某些情况下单位会攻击已经阵亡的目标（"鞭尸"）的问题。
- **"捕捉"技能逻辑**: 修复了当"捕捉"的目标在行动前已经死亡时，行动会卡住或出错的问题；现在会正确地终止该次捕捉尝试。
- **状态机数据流**: 修复了战斗结束后结果数据（如胜利/失败/捕获单位）没有被正确传递给调用者的问题。
- **UI稳定性**: 通过使用 `useCallback` 和优化 `ref` 管理，解决了由动画系统引起的无限重渲染循环问题。
- **VFX渲染问题**: 修正了VFX特效的CSS `z-index` 和动画冲突，确保它们能正确显示并且不会被单位遮挡。

## [0.3.7] - 2025-06-17 - "动感之击"

此版本对战斗系统的视觉表现力进行了核心增强，为"普通攻击"引入了一套全新的、富有冲击力的直接攻击动画，并为未来的扩展（如投射物攻击）奠定了基础。

### ✨ 新增 (Added)

-   **直接攻击动画**:
    -   当单位执行"普通攻击"时，它不再是原地播放动画，而是会真实地冲向目标。
    -   攻击方冲到目标面前的瞬间，目标单位会触发一个带有轻微后退效果的"受击"动画，增强了打击感。
    -   在受击动画的同时，会从目标头顶"跳出"伤害数值。
    -   攻击动画完成后，攻击方单位会自动返回其在战斗网格中的原始位置。
-   **动画系统扩展**:
    -   `AnimationPlayer` 现已支持 `MOVE_TO_TARGET` 和 `RETURN_TO_POSITION` 两种新的动画指令，使其能够处理单位的位置移动。
    -   通过在 `BattleSceneV3` 中建立一个全面的 `ref` 系统，`AnimationPlayer` 现在可以精确获取任何单位在屏幕上的实时坐标，为实现复杂的移动类动画提供了可能。

### ♻️ 变更 (Changed)

-   **动画实现优化**: `UnitDisplay` 组件现在使用 CSS `transform: translate()` 属性来处理单位的动态位置变化，相比之前直接修改 `top/left`，这种方式性能更高，动画效果也更平滑。

## [0.3.6] - 2025-06-17 - "运筹帷幄之中"

此版本为战斗系统引入了两个经典的策略性指令——"捕捉"与"逃跑"，并围绕"捕捉"构建了一套完整、清晰的交互体验，极大地丰富了战斗的策略维度和可玩性。

### ✨ 新增 (Added)

-   **捕捉指令**:
    -   玩家现在可以在行动选择中选择"捕捉"指令，尝试收服敌方单位。
    -   捕捉成功率与目标的已损失生命值正相关，血量越低，成功率越高。
    -   成功捕捉的单位会从战场移除，并在战斗结算时作为战利品返回。
    -   引入了 `isCapturable` 单位属性，从逻辑上防止玩家捕捉Boss或特殊单位。
-   **逃跑指令**:
    -   在准备阶段，玩家可以选择"逃跑"来立即结束战斗，战斗结果记为 `escaped`。

### 🎨 界面与体验优化 (UI & UX)

-   **捕捉成功率预览**: 当玩家选择"捕捉"技能并悬停在一个可捕捉的敌人身上时，其头顶会实时显示一个 tooltip，明确告知当前的捕捉成功率（例如"捕捉概率: 45%"）。
-   **清晰的目标反馈**:
    -   **结果动画**: 捕捉指令执行后，目标头顶会弹出"捕捉成功！"或"捕捉失败！"的浮动文字动画，提供即时的结果反馈。
    -   **视觉区分**: 不可被捕捉的单位，在被"捕捉"技能瞄准时，会自动变为半透明且无法被选中，光标也会变为"禁止"符号。
-   **UI适配**: 结算界面、回合结束公告等UI元素现在也能正确处理和显示"成功逃跑"的战斗结果。

### 🐛 错误修复与重构 (Bug Fixes & Refactoring)

-   **重大逻辑重构**: 修正了之前将"捕捉"逻辑错误地添加到V2旧版 `skillSystem.js` 的问题。现已将所有相关逻辑（包括动画脚本生成和结果处理）全部迁移并正确实现在V3核心状态机 `battleMachine.js` 中，确保了系统的正确性。
-   **状态机健壮性修复**:
    -   彻底修复了因 `context.logs` 未初始化而导致的 `is not iterable` 崩溃问题，采用了更具防御性的编码方式。
    -   修复了因 `execution` 状态的 `initial` 指向错误而导致的"跳过执行阶段"的严重bug。

## [0.3.5] - 2025-06-17 - "画龙点睛"

此版本通过为战斗的关键时刻（如回合开始、阶段转换）引入富有表现力的UI提示，显著增强了战斗的节奏感和沉浸感。

### ✨ 新增 (Added)

-   **阶段/回合切换公告**:
    -   在战斗场景中央新增了一个动态的、带有动画效果的公告组件 (`PhaseAnnouncer.jsx`)。
    -   当进入新回合、切换到行动阶段或战斗结束时，会显示如"第 X 回合"、"行动阶段"、"战斗胜利"等醒目提示。

### 🎨 界面与体验优化 (UI & UX)

-   **玻璃拟态与辉光效果**: 公告采用了与游戏整体UI统一的玻璃拟态（Glassmorphism）设计，拥有半透明模糊背景和辉光边框。文字也应用了辉光效果，使其在深色背景下更加突出和美观。
-   **精致的动画**: 公告的出现和消失伴随着平滑的淡入淡出、缩放及模糊动画，使过渡效果更加自然。
-   **迭代优化**: 根据反馈，对公告的尺寸、位置和样式进行了多次迭代微调，确保其在提供清晰信息的同时，不会遮挡核心战斗画面，达到了视觉上的和谐与平衡。

### 🐛 错误修复 (Bug Fixes)

-   修复了因在 XState 嵌套状态对象上错误使用字符串方法 `.startsWith()` 而导致的 `TypeError` 崩溃。现已替换为更健壮的 `state.matches()` 方法进行状态判断。
-   修复了公告组件在某些情况下无法正确定位到视口中心的问题，确保其在各种屏幕尺寸下都能完美居中。

## [0.3.4] - 2024-07-26 - 焕然一新

### ✨ 新功能 (Features)
- **战斗日志系统**: 在战斗界面右下角新增了一个可展开/收起的战斗日志面板。(#18)
- **格式化日志内容**: 彻底重构了日志生成逻辑，现在日志内容是对玩家友好的、格式化的文本，并根据事件类型（如行动、伤害、阵亡）进行颜色区分。(#18)
- **行动确认提示**: 当玩家为一个单位设置好行动后，该单位右上角会显示一个绿色的"✔"图标，提供了清晰的视觉反馈。(#19)

### 🎨 界面与体验优化 (UI & UX)
- **战场布局重构**: 对战斗场景进行了全面的重新布局，将3x3网格显著放大，使其成为视觉焦点。(#17)
- **中央信息面板**: 原底部信息栏被移至战场中央，改为垂直布局，并加入了醒目的 "VS" 标志，增强了对峙感。(#17)
- **固定行动选择器**: 原单位头顶的环形行动菜单被重构为固定在界面左侧的列表，操作更稳定、直接。(#16)
- **视觉风格统一**: 为行动条、信息面板、日志面板等多个核心UI组件应用了统一的玻璃拟态（Glassmorphism）设计风格，并为整个战场添加了深色渐变背景，大幅提升了视觉沉浸感。(#17)
- **UI状态保持**: 在进入"执行阶段"时，中央信息面板的文本和按钮不再隐藏，而是以禁用状态保留，使UI流程更连贯。(#20)

## [0.3.2] - 2024-07-25 - "运筹帷幄"

此版本专注于战斗界面的信息呈现和用户体验（UI/UX）的显著升级。通过引入一个全新的、高度可视化的"行动顺序尺子"，将原有的简单文本列表，革新为一个能直观反映战场速度态势的战术工具。

### ✨ 新增 (Added)

-   **行动顺序尺子 (Turn Order Ruler)**:
    -   新增了一个可视化的时间轴式尺子UI，以取代旧的行动顺序文本列表。
    -   **精准定位**: 所有单位的标记都会根据其速度值被精确地放置在尺子上，速度越快越靠右，使战场速度优劣一目了然。
    -   **动态刻度**: 尺子会根据当前场上单位的速度范围，动态生成带有数字的刻度，提供了精确的速度参考。
    -   **悬浮提示**: 当鼠标悬停在任意单位的标记上时，会显示包含其名称和具体速度值的提示框。
    -   **动态高亮与置灰**:
        -   **行动中**: 当前正在行动的单位，其在尺子上的标记会呈现独特的"呼吸灯"高亮动画，清晰地聚焦战场当前的核心。
        -   **行动后**: 在回合中已经完成行动的单位，其标记会被置灰，方便玩家追踪回合剩余的行动。

### ♻️ 变更 (Changed)

-   **组件解耦**: 行动顺序显示的全部逻辑和渲染已从主场景组件 `BattleSceneV3` 中分离，重构为一个独立、可复用的新组件 `TurnOrderRuler.jsx`，提升了代码的模块化和可维护性。
-   **状态机扩展**: 对核心状态机 `battleMachine.js` 的上下文（context）进行了扩展，现在它可以追踪每个回合中"当前行动单位"和"已完成行动的单位列表"，为UI层的动态视觉效果提供了可靠的数据支持。

---

## [0.3.1] - 2024-07-24

### ✨ 新功能 (Features)
- **3x3战斗网格布局**: 为我方和敌方单位引入了3x3的战斗网格布局，取代了原有的线性排列。
- **对称布局**: 敌方单位的网格布局会自动进行镜像处理，以实现经典的对阵视图。

### 🎨 界面与体验优化 (UI & UX)
- **精灵图替换文本**: 使用 `UnitDisplay` 组件，将原先的文本单元替换为真实的召唤兽精灵图（Sprite），并正确地翻转了我方单位的朝向。
- **未来感网格样式**: 为战斗网格设计了新的"能量网格"样式，使其更具科技感和未来感。

---
_版本号遵循 [语义化版本 2.0.0](https://semver.org/lang/zh-CN/) 规范。_ 