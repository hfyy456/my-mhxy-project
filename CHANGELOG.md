<!--
 * @Author: Sirius 540363975@qq.com
 * @Date: 2025-06-15 06:15:28
 * @LastEditors: Sirius 540363975@qq.com
 * @LastEditTime: 2025-06-16 06:33:30
-->
# 更新日志 (Changelog)

所有此项目的更改将记录在此文件中。

该格式基于 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)，
并且本项目遵循[语义化版本](https://semver.org/spec/v2.0.0.html)。

---

## [0.3.2] - 2025-06-15 - "运筹帷幄"

此版本专注于战斗界面的信息呈现和用户体验（UI/UX）的显著升级。通过引入一个全新的、高度可视化的"行动顺序尺子"，将原有的简单文本列表，革新为一个能直观反映战场速度态势的战术工具。

### ✨ 新增 (Added)

-   **行动顺序尺子 (Turn Order Ruler)**:
    -   新增了一个可视化的时间轴式尺子UI，以取代旧的行动顺序文本列表。
    -   **精准定位**: 所有单位的标记都会根据其速度值被精确地放置在尺子上，速度越快越靠右，使战场速度优劣一目了然。
    -   **动态刻度**: 尺子会根据当前场上单位的速度范围，动态生成带有数字的刻度，提供了精确的速度参考。
    -   **悬浮提示**: 当鼠标悬停在任意单位的标记上时，会显示包含其名称和具体速度值的提示框。
    -   **动态高亮与置灰**:
        -   **行动中**: 当前正在行动的单位，其在尺子上的标记会呈现独特的"呼吸灯"高亮动画，清晰地聚焦战场当前的核心。
        -   **行动后**: 在回合中已经完成行动的单位，其标记会被置灰，方便玩家追踪回合剩余的行动。

### ♻️ 变更 (Changed)

-   **组件解耦**: 行动顺序显示的全部逻辑和渲染已从主场景组件 `BattleSceneV3` 中分离，重构为一个独立、可复用的新组件 `TurnOrderRuler.jsx`，提升了代码的模块化和可维护性。
-   **状态机扩展**: 对核心状态机 `battleMachine.js` 的上下文（context）进行了扩展，现在它可以追踪每个回合中"当前行动单位"和"已完成行动的单位列表"，为UI层的动态视觉效果提供了可靠的数据支持。

---

## [0.3.1] - 2025-06-15 - "拨乱反正"

此版本专注于修复 V3 战斗系统在集成阶段暴露出的多个核心 BUG，并实装了完整的手动操作流程，使战斗系统从技术演示阶段真正进入可玩阶段。

### 🐞 修复 (Fixed)

-   **核心流程**: 修复了战斗开始后，状态机由于错误的 `always` 转换导致战斗流程自动执行的严重问题。现在回合的开始完全由玩家通过UI手动触发。
-   **AI 逻辑**:
    -   修复了因竞态条件（UI提交速度快于AI生成速度）导致AI单位在第一回合没有指令的BUG。新的流程确保在所有AI指令生成且玩家指令提交后，战斗才进入执行阶段。
    -   修复了AI指令生成逻辑中的一个错误，该错误导致只有部分敌方单位能获取行动指令。
-   **渲染时序**: 修复了因状态机异步初始化 `context` 导致的UI渲染崩溃问题 (`TypeError: Cannot convert undefined or null to object`)。
-   **数据流**: 修复了从 `zustand` 获取的纯数据对象（非类实例）直接传递给战斗系统导致的方法调用失败问题。

### ✨ 新增 (Added)

-   **手动操作UI**: 在 `BattleSceneV3` 中实现了完整的、可交互的回合制操作界面。玩家现在可以：
    -   点击选择我方单位。
    -   为选中的单位选择目标。
    -   在所有单位都下达指令后，点击"执行回合"按钮来开始战斗。

### ♻️ 变更 (Changed)

-   **重构-数据转换**: 将战斗单位的实例化 (`new Summon()`) 和序列化 (`toBattleJSON()`) 逻辑从 `GamePage` 移至 `BattlePreparationModal`，确保了进入战斗系统的数据源头是纯净和正确的。
-   **重构-AI接口**: 重构了 `battleAI.js` 中的 `setEnemyUnitsActions` 函数，使其接口更清晰，不再依赖于内部逻辑来分辨敌我双方，从根本上提升了AI行为的健壮性。

---

## [0.3.0] - 2025-06-15 - "凤凰涅槃"

这是一个里程碑式的版本，我们对核心战斗体验和开发工作流程进行了彻底的现代化重构。引入了全新的、基于状态机的 V3 战斗系统和一个配套的、强大的可视化技能动画编辑器。

### ✨ 新增 (Added)

-   **战斗系统 V3 (`/features/battle/v3`)**
    -   引入了一个基于 **XState** 的全新战斗引擎，以取代原有的 V2 自定义引擎。
    -   新架构通过一个统一、声明式且可视化的状态机 (`battleMachine.js`) 管理所有战斗流程，极大地降低了逻辑的复杂性和开发者的心智负担。
    -   建立了清晰、可预测的单向数据流模式：`UI -> send(event) -> Machine -> update(state) -> UI`。
    -   实现了一套极其健壮的战斗重置机制。通过 React 的 `key` 属性，现在可以彻底销毁并重建整个战斗实例，确保了"重新开始"功能的纯净性。

-   **技能动画导演编辑器 (`/features/skill-editor`)**
    -   新增一个强大的、所见即所得的可视化编辑器，用于创建和编排技能动画。
    -   将技能的**逻辑效果 (`effects`)** 与**视觉表现 (`animationScriptTemplate`)** 在 `skillConfig.js` 中完全分离，实现了策划、美术与程序的高效协作。
    -   编辑器提供了一个基于时间轴的界面，支持通过**拖放**来排序动画步骤，并通过**滑块**精确调整每个步骤的**延迟**。
    -   内置一个独立的**实时预览窗口**，可以在沙箱化的战斗环境中立即查看动画修改后的效果。

-   **核心架构与模式**
    -   引入 `BattleLifecycleContext`，建立了一个优雅的、非侵入式的通道，允许深层嵌套的UI组件请求顶层父组件重置状态。

### 📄 文档 (Documentation)

-   为 V3 战斗系统创建了全新的 `README.md`，详细记录了：
    -   设计哲学与目标
    -   使用 Mermaid.js 绘制的架构图
    -   核心工作流程
    -   **踩坑实录**：总结了从 XState V4 到 V5 迁移的各种陷阱和状态机设计的关键注意事项。

-   为技能动画编辑器创建了全新的 `README.md`，详细记录了：
    -   编辑器的设计目标和核心概念（如"动画剧本"）。
    -   组件架构图和清晰的工作流程。
    -   对核心数据结构 `skillConfig.js` 的完整注释和说明。

### ♻️ 变更 (Changed)

-   **重构**: 废弃了 V2 战斗引擎的实现思路，转向业界标准的有限状态机（FSM）解决方案。
-   **状态管理**: 将战斗的核心状态管理从自定义的类实例，转移到了由 XState actor 和 React Provider 共同驱动的模式。 