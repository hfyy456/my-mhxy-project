# 战斗系统流程说明

## 概述

本文档描述了梦幻西游项目中战斗系统的核心逻辑流程和模块划分。战斗系统被拆分为多个专门的模块，每个模块负责特定的功能，以提高代码的可维护性和可扩展性。

## 模块结构

战斗系统的逻辑被划分为以下几个主要模块：

### 1. 战斗核心逻辑 (battleLogic.js)

负责战斗的基础流程控制，包括：
- 战斗单位的创建和初始化
- 战斗回合的管理
- 战斗阵型的处理
- 战斗胜负的判定

### 2. 伤害计算系统 (damageCalculation.js)

专门处理所有与伤害和治疗相关的计算，包括：
- 物理伤害计算
- 法术伤害计算
- 暴击判定和伤害加成
- 伤害减免计算
- 治疗量计算
- 伤害和治疗的应用

### 3. 技能系统 (skillSystem.js)

处理技能相关的逻辑，包括：
- 技能目标选择
- 技能影响范围计算
- 技能效果应用
- 攻击距离和范围判定
- 战场距离计算

### 4. 状态效果管理 (buffManager.js)

管理战斗中的各种状态效果（buff/debuff），包括：
- 状态效果的应用
- 状态效果的移除
- 状态效果的回合处理
- 状态效果对单位属性的影响

### 5. 战斗AI (battleAI.js)

控制敌方单位的行动决策，包括：
- 目标选择策略
- 技能使用策略
- 行动优先级判断

## 战斗流程

### 1. 战斗初始化

```
初始化战斗 → 创建战斗单位 → 确定初始回合顺序 → 开始战斗
```

- **初始化战斗**：创建战斗ID，准备战斗环境
- **创建战斗单位**：根据玩家阵容和敌方配置创建战斗单位
- **确定初始回合顺序**：基于单位速度和其他属性计算行动顺序

### 2. 回合执行

```
回合开始 → 状态效果处理 → 行动选择 → 行动执行 → 结果计算 → 回合结束
```

- **回合开始**：确定当前行动单位
- **状态效果处理**：处理回合开始时的状态效果
- **行动选择**：
  - 玩家单位：由玩家选择行动类型、目标和技能
  - 敌方单位：由AI决定行动
- **行动执行**：执行选定的行动
- **结果计算**：计算伤害、治疗或状态效果
- **回合结束**：处理回合结束时的状态效果，更新行动顺序

### 3. 技能执行流程

```
选择技能 → 选择目标 → 计算影响范围 → 应用技能效果 → 更新战场状态
```

- **选择技能**：从单位可用技能中选择
- **选择目标**：根据技能类型选择合适的目标
- **计算影响范围**：确定技能影响的格子和单位
- **应用技能效果**：计算并应用伤害、治疗或状态效果
- **更新战场状态**：更新单位状态和战场显示

### 4. 伤害计算流程

```
确定伤害类型 → 获取攻击和防御属性 → 计算基础伤害 → 应用暴击 → 应用技能加成 → 应用减伤 → 计算最终伤害
```

- **确定伤害类型**：物理或法术
- **获取属性**：获取攻击者和防御者的相关属性
- **计算基础伤害**：根据攻防属性计算基础伤害值
- **应用暴击**：判定是否暴击并计算暴击伤害
- **应用技能加成**：应用技能提供的伤害加成
- **应用减伤**：计算目标的伤害减免效果
- **计算最终伤害**：应用随机浮动，得出最终伤害值

### 5. 战斗结束判定

```
回合结束 → 检查单位存活状态 → 判断胜负 → 结算战斗奖励
```

- **检查单位存活**：检查所有单位的生命值
- **判断胜负**：
  - 所有敌方单位被击败：玩家胜利
  - 所有玩家单位被击败：玩家失败
  - 达到最大回合数：平局
- **结算奖励**：计算并发放战斗奖励

## 模块间的交互

各模块之间通过明确的接口进行交互，主要交互流程如下：

1. **battleLogic.js** 作为核心模块，协调其他模块的工作
2. 当需要执行技能时，调用 **skillSystem.js** 中的函数处理技能效果
3. 计算伤害时，调用 **damageCalculation.js** 中的函数进行伤害计算
4. 应用状态效果时，调用 **buffManager.js** 中的函数管理状态效果
5. 敌方单位行动时，调用 **battleAI.js** 中的函数决定行动策略

## 数据流向

```
配置数据 → 战斗初始化 → 战斗状态 → 用户界面
                ↓
              行动执行 ← 用户输入/AI决策
                ↓
              状态更新
                ↓
              战斗结果
```

- **配置数据**：包括单位属性、技能配置、装备效果等
- **战斗状态**：包括单位当前状态、回合信息、行动顺序等
- **用户界面**：显示战斗状态，接收用户输入
- **状态更新**：根据行动结果更新战斗状态
- **战斗结果**：决定战斗的最终结果和奖励

## 扩展性考虑

战斗系统设计考虑了以下扩展性需求：

1. **新技能类型**：可以在 skillSystem.js 中添加新的技能处理逻辑
2. **新状态效果**：可以在 buffManager.js 中添加新的状态效果类型
3. **新的AI策略**：可以在 battleAI.js 中实现新的决策算法
4. **战斗机制调整**：核心计算公式集中在各自模块中，便于调整和平衡

## 未来改进方向

1. 实现更复杂的连击和连携系统
2. 添加天气和地形对战斗的影响
3. 实现更智能的敌方AI决策系统
4. 优化伤害计算公式，提高游戏平衡性
5. 添加更多类型的状态效果和技能效果
